{
    "variables": {
      "access_key": "{{env `AWS_ACCESS_KEY_ID`}}",
      "secret": "{{env `AWS_SECRET_ACCESS_KEY`}}"
    },
    "builders": [
        {
            "type": "amazon-ebs",
            "region": "us-east-2",
            "source_ami_filter": {
                "filters": {
                "name": "amzn2-ami-hvm-*-x86_64-gp2"
                },
                "owners": ["137112412989"],
                "most_recent": true
            },
            "instance_type": "t2.medium",
            "ssh_username": "ec2-user",
            "ami_name": "mhm-doccano-stg"
        }
    ],
    "provisioners": [
      {
        "type":  "shell",
        "inline": [
          "export AWS_ACCESS_KEY_ID={{user `access_key`}}",
          "export AWS_SECRET_ACCESS_KEY={{user `secret`}}",
          "sudo yum install -y git",
          "sudo yum install -y docker",
          "sudo yum -y install python-pip",
          "sudo systemctl start docker",
          "sudo usermod -a -G docker ec2-user",
          "sudo systemctl enable docker",
          "sudo curl -L \"https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose",
          "sudo chmod +x /usr/local/bin/docker-compose",
          "sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose",
          "docker-compose --version",
          "sudo pip install git-remote-codecommit",
          "git config --global credential.helper \"!aws codecommit credential-helper $@\"",
          "git config --global credential.UseHttpPath true",
          "git clone https://git-codecommit.us-east-2.amazonaws.com/v1/repos/doccano_mhm",
          "cd doccano_mhm",
          "sudo docker-compose build",
          "sudo docker-compose up -d"
        ]
      }
    ]
}